#!/usr/bin/env node
const db = require('../db')
const { validQuery } = require('../lib/publisherVerification')

const grantAccs = [
	'0xB7d3F81E857692d13e9D63b232A90F4A1793189E',
	'0x117480AB9DE66775F8EF5Ab54dBD0058282d6136',
	'0x033Ed90e0FeC3F3ea1C9b005C724D704501e0196',
	'0x8646e058e054aF6c29b8e3E97EaF8c3B71D78Ff6',
	'0x13e72959d8055DaFA6525050A8cc7c479D4c09A3',
	'0xc8e0f647A0F5fB3005217dB62f66FBB4857FfD8b',
	'0x2F9b3818349349093bb263BaAf31DdB5d4aA9dC4',
	'0x98D6791Ed0a1B438e4C3eF8Aa3Fa1f0bbf74d207',
	'0x70A28DFbD586d24b8CBA1dA63CF576a8c6ccdB1F',
	'0x4a8d20c9695AB568b0E78fdC22B3648EcFEba82E',
	'0x68299E6FbdFCb3eBF4513922875591000a9d4EF8',
	'0x5C19fAA84AB1917De21E8FFc218762ce627bbae2',
	'0xD4e4a0656F0e885217f90466aaBF65A1b69E61e1',
	'0xcC6C736449403C34FD6d194c7dA1afb569b863A4',
	'0xB10b92F3FeAcCB19268900f98acaAa9Ba6b307d1',
	'0xde305B7971Fa8be13DBaBc42386f2e59276D232E',
	'0xa5C126d99DADF49583Cc107A7E2d2d260cf380Eb',
	'0x46805cDB116F98c091aC551Df45dD1d0a47E8308',
	'0x28e4068Cd509177a38158744c83B9A28a03a3e45',
	'0xB0893B75d1Deb89F79837bB0BBC95d022E55AC06',
	'0x1d5178e1079295e0b0C838EBEB385c4EC0D6dd1b',
	'0x41391ddB232B33824237a98429570db8E2867313',
	'0xe370585dBCF0E2B2A6351FEe064B3a79073771bc',
	'0xe2235C4B15F2Ed01e386dcd40d00A7aa035F546B',
	'0x2572000D67B899EABC570579912043a85f4cb06F',
	'0xCdFfA5E6931D9619b75Cc4145f55A7E6a295ee5E',
	'0x89A0153153d5CeEb886F6bD39BB4071B2277923b',
	'0xd5860D6196A4900bf46617cEf088ee6E6b61C9d6',
	'0x6fB23F231336598d3cF440C3F7cfd4db1788E16D',
	'0x3cB8E4Bf87a5E06F6b6B722FB3535020d5fd63f1',
	'0x88c37e9b28394678ff2a12b834349C94a6B20126',
	'0x5EdE43252C7c8BB6B2E57856D96c680B8AfEa5d4',
	'0x54d38C925be0EEedDb2CF1335b425c16c518B980',
	'0xF71A9eDAccA6bbcd1ab06a1c0BEb2CEd0506CcBB',
	'0xe586ca05A149512229049B3f101c595cc4CbFff8',
	'0x5e2878C6Ce57699dA63929FAf8E7F1B5dA8949e2',
	'0xc99CA91506109F8d2F4e26887762eCbFe7710BB1',
	'0xA5809bBA886a42c054f79d6Be856318409C8c2C3',
	'0xEbeAFc6966bD089d7cE51B0Dcd771670DE1932b4',
	'0x1de6c3bACB400A75c2866Fdf4e71198Bb482f405',
	'0xbF90D949c1468De3F2783Fb404e365Ca2c1eFC31',
	'0xC95C16a2B4551a7d14310936DfE4ADc7C16fcE22',
	'0x30e9729942Eb0af63952112097c60d20aA14a982',
	'0xCa352f98bB5DaC79a4d5F7747f88c0D9F5c5db42',
	'0x99224cBe8EfB49ffCe3e2f1f061aAcAB9E0534a7',
	'0x06E75153199243C4d5D57A1a27a3A84A3A659780',
	'0x0eE786deD3E0d540F082531781574a3cd8A3Cb1e',
	'0x64742b820C2E8cC914b8759868F2034d1f2831c5',
	'0xa561D2168F461d18aF380B6353F8a9C423b4D4E8',
	'0x65B74360431964f587bDcc5fE18C187DC37De286',
	'0x32Bc00c3A240E2E952d8963C48958D2137c749f3',
	'0x5d62321228bC75936dd29f9c129f8DbDfcB93264',
	'0x4A1E4Cf4DFE212762BfDd31F260FF3E4226e196D',
	'0x9EC6546e7C4DE4A78E77773B1EC1a96F92DcF97a',
	'0x7eCF15c2f2d97d320215fe0C030396b247B425C5',
	'0x8Dea68Da33dc8BDA35bD697a068295B48e6E38fB',
	'0xa7F88A70eE6625805045d6a16226976516762537',
	'0xC91763D7F14ac5c5dDfBCD012e0D2A61ab9bDED3',
	'0xF7E01B0E91d6Ac30966876e8D56cACC120Cc94A9',
	'0xD3208724944eF977F8e944999998F43D040D31BB',
	'0x6B6fC9491181163Dca51b2e5d3927De5C6Ad0b8A',
	'0x20754168c00A6e58116CcFd0a5F7D1bb66c5dE9D',
	'0x2054B0c1339309597Ad04Ba47f4590f8cDB4e305',
	'0x0b7eCe46040298A07E5693d6e533894CcC339A2b',
	'0x5d6A3F1AD7b124ecDFDf4841D9bB246eD5fBF04c',
	'0x5495B410495Bbf0242318ece4eeCCFa0308336fb',
	'0xC265FCb5f26990f367c42098724d2bce8eba1415',
	'0x6353E3309B79dc203246Fa7E484CFaA0fA1BbB5B',
	'0xa46Cb2a74Afe1dD69735A45CC31147D730F5AeA9',
	'0xd7d6FD974269036D3D1CBFB260Db728EB47ba1ee',
	'0x52F6a96Dd04e501A7f207172d0bfc44FA2cCE0D4',
	'0xDc83da15974e195374D6769f1EcE234914ba2Fa6',
	'0x3a3F02AD3E1D41E96B9652A5FD5D81Ae45674c35',
	'0xEdC9C1901D07aF594746198AcF4Be5a83e92a208',
	'0x32f5eA7Ae84613D2a2B1A1fd710789F9Feee5ea3',
	'0x48B6D5748885988cB657A06647C05Fc2Af1ffaCf',
	'0xE06d665BF2B7dC2aFbd22ad5965a27eb07F3c912',
	'0xEb1C6E97D5f7C6772A33886Fc0d6847AE84684f2',
	'0xad24CAd40886884b54218ed7Ed69B2F9041413a2',
	'0x21CD5b5629ce4b0D42EA1c9CCd5CBb9b2aa99D1A',
	'0x817c5a8bB339BFa5753DBea9c2Ed2Ed0F89DF71B',
	'0xebfdB7Ca5887b46288E73F0E166b5c78417f9e22',
	'0xD4fd07fB6C51393Ce0f492fa61ba82D74F760147',
	'0x79129303835C2575a426c588716881962d3DAfC9',
	'0xBaddfb42B2dcc271D0B7B8136171857a539000b9',
	'0xf78426Ff2Fe224057A1e2E8D1a545683c3d8f0CC',
	'0x5e9D6F75F204F039aCbaBdC3676082ED55CE4C55',
	'0x935C2aaCB24D3019D414C3969526255be7Dafedf',
	'0xBB428685E88848Cc5b4cf53fB4dC930EAf29ed44',
	'0x6b2ec8AD6c0B89d99eb7F243A5f1D4F56493DaC6',
	'0xA345430795A4f8C1778D708E1f212Db1d2823B2B',
	'0x8994A11a8A68B959Bc16b06eE92f8e3cA481C4DD',
	'0xAf89dc18888Bdb1eE89fB18A061019FaDa7F9B9e',
	'0x06680e6a2B09960F259B728e84F7730D266c301A',
	'0x1851285372Ab997C4F1E9a70113c7998dF31d742',
	'0x385D1620Af6796dE844f82b521D7C2Ce25fF2996',
	'0x8373a4dD2Fd22f452afc61f27B54A4e6554104EA',
	'0x4B215FC727f0810dcFcBd3AC554c36a1A20f4b5C',
	'0x78a9C4179d2d9A6CC726AE32d95F6611e95e6ff5',
	'0x6F0B465eC1B0d32fb3D7eCe31723677092Fb2e81',
	'0x13Ee47655B361a40C21C46f9c2742DC0f6a755E7',
	'0x8dde78758a312F55f854De316deA1599F275e571',
	'0x36eaF297Ac5a378333e7bbF401c1324459eaBd11',
	'0x826Cbd2E30902FEfc2d949C0B9D0BD1eb861Fc42',
	'0x051Cb0EC820EB5e7C72c2519c5d31ebD367a2C24',
	'0x78917B837A3945A7eda16F30b627a1d8c6EA8417',
	'0x736AAef9561e322e9BE7c5B6811f85Ee5700C28C',
	'0x9793Ac3F0254B3E243B0179c9abC8F1b972B46D5',
	'0x91c7D01A25C61cEe21A7E3F14018f526C6447aA0',
	'0x1B2ab9f26f68790eA5E2b0f1756040070d1f670A',
	'0x0106a9dA9578760C1854f8666BAF07605452CD6b',
	'0xbCBaD199FC6F4F206b2626c19fa2a14E83C508cC',
	'0xEcfe713B9352D40837b78f4D35D05016CFCC95B9',
	'0xF30Df47c7aB5b37D5F8ea4DfbA38a498268E5E3e',
	'0xd6c4B4aDa6F7f27D3A213636565CaFD283f8119C',
	'0xad1325639F87e39Cdf16A206D1cB998Fa44288B0',
	'0xA0ab53f6Ce545cCC10441ECb3c442422FE496FD6',
	'0xFF77AE59F531e28052a98732377740CAfaA9F3Ac',
	'0x3F1e4c891AE446d723AE33A0b1e3e59aaAD4EED0',
	'0x0246BA1fDD46f88B53bB27E3cC31B37D3735370f',
	'0x2D1710677c8F9BAC9b675aE0CC8B9eE05B366ACE',
	'0x3EB036420812f8560C530b9dE88a7ac54404A6Da',
	'0xCac7F5AB5F058ed0cF74fd555F5F280C06533c4E',
]

async function getWAF() {
	await db.connect()
	const publishers = (
		await db
			.getMongo()
			.collection('websites')
			.find(validQuery)
			.toArray()
	)
		.map(x => x.publisher)
		.sort()
		.filter((el, i, arr) => arr.indexOf(el) === i)

	if (!publishers.length) return ``
	const withLowerCase = publishers
		.map(addr =>
			grantAccs.includes(addr) ? [addr, addr.toLowerCase()] : [addr]
		)
		.reduce((a, b) => a.concat(b), [])
	const matchRule = `and not http.request.full_uri matches "${withLowerCase
		.map(x => x.slice(2, 12))
		.join('|')}"`
	return `(http.host eq "market.moonicorn.network" and http.request.full_uri contains "limitForPublisher=" ${matchRule})`
}

getWAF()
	.then(waf => {
		console.log(waf)
		process.exit(0)
	})
	.catch(console.error)
